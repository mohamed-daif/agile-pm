name: Database Migrations

on:
  push:
    branches: [main]
    paths:
      - 'alembic/**'
      - 'src/agile_pm/storage/models.py'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run migrations'
        required: true
        type: choice
        options:
          - staging
          - production
      action:
        description: 'Migration action'
        required: true
        type: choice
        options:
          - upgrade
          - downgrade

jobs:
  validate:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: pip install -e ".[dev]"
      
      - name: Validate migrations
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
        run: |
          # Run all migrations
          alembic upgrade head
          
          # Verify schema matches models
          alembic check
          
          # Test downgrade
          alembic downgrade -1
          alembic upgrade head

  migrate-staging:
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment: staging
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: pip install -e .
      
      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
        run: |
          if [ "${{ github.event.inputs.action }}" == "downgrade" ]; then
            alembic downgrade -1
          else
            alembic upgrade head
          fi
      
      - name: Verify migration
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
        run: alembic current

  migrate-production:
    runs-on: ubuntu-latest
    needs: migrate-staging
    if: github.event.inputs.environment == 'production'
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: pip install -e .
      
      - name: Create backup
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
        run: |
          pg_dump $DATABASE_URL > backup-$(date +%Y%m%d-%H%M%S).sql
      
      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
        run: |
          if [ "${{ github.event.inputs.action }}" == "downgrade" ]; then
            alembic downgrade -1
          else
            alembic upgrade head
          fi
